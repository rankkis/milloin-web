<div appCard>
  <div appCardHeader
       title="on paras hetki pest√§ pyykki√§?"
       subtitle="Saa AI-avusteiset suositukset s√§hk√∂n hinnan ja aikataulun perusteella"
       [showBackButton]="true"
       backButtonTestId="wash-laundry-back-button"
       [showRefreshButton]="true"
       refreshButtonTestId="refresh-schedule-button"
       (refreshClicked)="getOptimalSchedule()">
  </div>
  <div appCardContent>
    <div class="wash-laundry-content" *ngIf="optimalSchedule$ | async as state">

      <!-- Loading State -->
      <div *ngIf="state.loading" class="loading-container">
        <p>Ladataan optimaalisia pesuaikoja...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="state.error && !state.loading" appCardContentHighlighted class="error-container">
        <p><strong>Virhe:</strong> {{ state.error }}</p>

        <div class="error-actions">
          <button
            type="button"
            class="retry-button"
            data-test-id="retry-schedule-button"
            (click)="getOptimalSchedule()">
            Yrit√§ uudelleen
          </button>
        </div>
      </div>

      <!-- Success State with Schedule Data -->
      <div *ngIf="state.data && !state.loading && !state.error" class="schedule-container">

        <!-- Primary Recommendation: Today's Best Time (Highlighted) -->
        <div *ngIf="state.data.today" class="primary-recommendation" appCardContentHighlighted>

          <!-- Special message when currently in optimal time AND price is actually good -->
          <div *ngIf="shouldRecommendNow(state.data.today)">
            <h3>üéâ NYT on t√§ydellinen aika pest√§ pyykki√§! üß∫‚ú®</h3>
            <div class="current-optimal-time">
              <p class="now-message">‚è∞ Olet nyt optimaalisessa aikaikkunassa!</p>
              <p class="price-info">Spot-hinta: <strong class="{{ getPriceCssClass(state.data.today.priceCategory) }}">{{ getPriceEmoji(state.data.today.priceCategory) }} {{ state.data.today.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.today.priceCategory) }})</p>
              <p class="cost-info">Pesun hinta: <strong class="{{ getPriceCssClass(state.data.today.priceCategory) }}">{{ centsToEuros(state.data.today.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
              <p class="action-message">üëç K√§ynnist√§ pesukone nyt saadaksesi parhaan hinnan!</p>
            </div>
          </div>

          <!-- Message when currently in optimal time but price is not that good -->
          <div *ngIf="isCurrentlyOptimalTime(state.data.today) && !shouldRecommendNow(state.data.today)">
            <h3 class="{{ getPriceCssClass(state.data.today.priceCategory) }}">‚ö†Ô∏è Olet optimaalisessa aikaikkunassa. Hinta ei kuitenkaan ole erityisen halpa vaan l√§hinn√§ ~{{ getPriceCategoryText(state.data.today.priceCategory) }}</h3>
            <div class="current-optimal-time">
              <p class="now-message">‚è∞ T√§m√§ on paras saatavilla oleva aika, mutta s√§hk√∂ on kalliimpaa</p>
              <p class="price-info">Spot-hinta: <strong class="{{ getPriceCssClass(state.data.today.priceCategory) }}">{{ getPriceEmoji(state.data.today.priceCategory) }} {{ state.data.today.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.today.priceCategory) }})</p>
              <p class="cost-info">Pesun hinta: <strong class="{{ getPriceCssClass(state.data.today.priceCategory) }}">{{ centsToEuros(state.data.today.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
              <p class="action-message">ü§î Harkitse odottamaan halvempaa aikaa, jos mahdollista</p>
            </div>
          </div>

          <!-- Normal message when optimal time is not now -->
          <div *ngIf="!isCurrentlyOptimalTime(state.data.today)">
            <h3>üü¢ Paras aika pest√§ pyykki√§ on t√§n√§√§n</h3>
            <div class="primary-time">
              <p class="time-display">{{ state.data.today.startTime | date:'HH:mm' }} - {{ state.data.today.endTime | date:'HH:mm' }}</p>
              <p class="price-info">Spot-hinta: <strong class="{{ getPriceCssClass(state.data.today.priceCategory) }}">{{ getPriceEmoji(state.data.today.priceCategory) }} {{ state.data.today.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.today.priceCategory) }})</p>
              <p class="cost-info">Pesun hinta: <strong class="{{ getPriceCssClass(state.data.today.priceCategory) }}">{{ centsToEuros(state.data.today.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
              <p class="savings-info" *ngIf="state.data.today.potentialSavingsCents > 0">
                <strong>üí∞ S√§√§st√∂ vs. nyt: </strong> <strong class="price-cheap">{{ centsToEuros(state.data.today.potentialSavingsCents) | number:'1.2-2' }} ‚Ç¨</strong> (<strong>{{ state.data.today.potentialSavingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info" *ngIf="state.data.today.priceCategory === 'VERY_CHEAP' || state.data.today.priceCategory === 'CHEAP'">
                <strong>üí° Erinomainen aika: </strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.today.priceCategory) }}
              </p>
              <p class="optimal-info" *ngIf="state.data.today.priceCategory === 'NORMAL'">
                <strong>üí° Normaali aika: </strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.today.priceCategory) }}
              </p>
              <p class="optimal-info" *ngIf="state.data.today.priceCategory === 'EXPENSIVE' || state.data.today.priceCategory === 'VERY_EXPENSIVE'">
                <strong>‚ö†Ô∏è Paras saatavilla oleva:</strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.today.priceCategory) }}, harkitse odottamista
              </p>
            </div>
          </div>
        </div>

        <!-- Fallback: No Today Available - Highlight Best Available -->
        <div *ngIf="!state.data.today && (state.data.tonight || state.data.tomorrow)" class="primary-recommendation" appCardContentHighlighted>
          <h3>üü¢ Paras saatavilla oleva aika</h3>

          <!-- Show tonight if available, otherwise tomorrow -->
          <div *ngIf="state.data.tonight; else tomorrowFallback" class="primary-time">
            <p class="period-label">T√§n√§ y√∂n√§</p>
            <p class="time-display">{{ state.data.tonight.startTime | date:'HH:mm' }} - {{ state.data.tonight.endTime | date:'HH:mm' }}</p>
            <p class="price-info">Spot-hinta: <strong class="{{ getPriceCssClass(state.data.tonight.priceCategory) }}">{{ getPriceEmoji(state.data.tonight.priceCategory) }} {{ state.data.tonight.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.tonight.priceCategory) }})</p>
            <p class="cost-info">Pesun hinta: <strong class="{{ getPriceCssClass(state.data.tonight.priceCategory) }}">{{ centsToEuros(state.data.tonight.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
            <p class="optimal-info" *ngIf="state.data.tonight.priceCategory === 'VERY_CHEAP' || state.data.tonight.priceCategory === 'CHEAP'">
              <strong>üí° Erinomainen aika: </strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.tonight.priceCategory) }}
            </p>
            <p class="optimal-info" *ngIf="state.data.tonight.priceCategory === 'NORMAL'">
              <strong>üí° Normaali aika: </strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.tonight.priceCategory) }}
            </p>
            <p class="optimal-info" *ngIf="state.data.tonight.priceCategory === 'EXPENSIVE' || state.data.tonight.priceCategory === 'VERY_EXPENSIVE'">
              <strong>‚ö†Ô∏è Paras saatavilla oleva:</strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.tonight.priceCategory) }}, harkitse odottamista
            </p>
          </div>

          <ng-template #tomorrowFallback>
            <div *ngIf="state.data.tomorrow" class="primary-time">
              <p class="period-label">Huomenna</p>
              <p class="time-display">{{ state.data.tomorrow.startTime | date:'HH:mm' }} - {{ state.data.tomorrow.endTime | date:'HH:mm' }}</p>
              <p class="price-info">Spot-hinta: <strong class="{{ getPriceCssClass(state.data.tomorrow.priceCategory) }}">{{ getPriceEmoji(state.data.tomorrow.priceCategory) }} {{ state.data.tomorrow.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.tomorrow.priceCategory) }})</p>
              <p class="cost-info">Pesun hinta: <strong class="{{ getPriceCssClass(state.data.tomorrow.priceCategory) }}">{{ centsToEuros(state.data.tomorrow.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
              <p class="optimal-info" *ngIf="state.data.tomorrow.priceCategory === 'VERY_CHEAP' || state.data.tomorrow.priceCategory === 'CHEAP'">
                <strong>üí° Erinomainen aika: </strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.tomorrow.priceCategory) }}
              </p>
              <p class="optimal-info" *ngIf="state.data.tomorrow.priceCategory === 'NORMAL'">
                <strong>üí° Normaali aika: </strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.tomorrow.priceCategory) }}
              </p>
              <p class="optimal-info" *ngIf="state.data.tomorrow.priceCategory === 'EXPENSIVE' || state.data.tomorrow.priceCategory === 'VERY_EXPENSIVE'">
                <strong>‚ö†Ô∏è Paras saatavilla oleva:</strong> S√§hk√∂ on {{ getPriceCategoryText(state.data.tomorrow.priceCategory) }}, harkitse odottamista
              </p>
            </div>
          </ng-template>
        </div>

        <!-- Alternative Options: Tonight/Tomorrow (Regular styling) - Only show alternatives that are NOT already the primary recommendation -->
        <div *ngIf="(state.data.tonight && state.data.today) || (state.data.tomorrow && (state.data.today || (!state.data.today && state.data.tonight)))" class="alternatives-section">
          <h4>Vaihtoehtoiset ajat</h4>

          <!-- Tonight's Alternative - Only show if today exists (so tonight isn't the primary) -->
          <div *ngIf="state.data.tonight && state.data.today" class="time-slot alternative">
            <h5>... jos pyykin pesu y√∂ll√§ kiinnostaa niin se voisi kannattaa</h5>
            <div class="alternative-details">
              <p><strong>Aika: </strong><strong class="{{ getPriceCssClass(state.data.tonight.priceCategory) }}">{{ state.data.tonight.startTime | date:'HH:mm' }} - {{ state.data.tonight.endTime | date:'HH:mm' }}</strong></p>
              <p><strong>Spot-hinta: </strong> <strong class="{{ getPriceCssClass(state.data.tonight.priceCategory) }}">{{ getPriceEmoji(state.data.tonight.priceCategory) }} {{ state.data.tonight.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.tonight.priceCategory) }})</p>
              <p><strong>Pesun hinta: </strong> <strong class="{{ getPriceCssClass(state.data.tonight.priceCategory) }}">{{ centsToEuros(state.data.tonight.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
              <p class="savings-comparison" *ngIf="state.data.tonight.potentialSavingsCents > 0">
                <strong>üí∞ S√§√§st√∂ vs. nyt: </strong> <strong class="price-cheap">{{ centsToEuros(state.data.tonight.potentialSavingsCents) | number:'1.2-2' }} ‚Ç¨</strong> (<strong>{{ state.data.tonight.potentialSavingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info">
                <strong>üí°</strong> Vaihtoehtoinen {{ getPriceCategoryText(state.data.tonight.priceCategory) }} aika
              </p>
            </div>
          </div>

          <!-- Tomorrow's Alternative - Only show if it's not the primary recommendation -->
          <div *ngIf="state.data.tomorrow && (state.data.today || (!state.data.today && state.data.tonight))" class="time-slot alternative">
            <h5>... jos huomiseen voit s√§√§st√§√§, niin se voisi kannattaa</h5>
            <div class="alternative-details">
              <p><strong>Aika: </strong><strong class="{{ getPriceCssClass(state.data.tomorrow.priceCategory) }}">{{ state.data.tomorrow.startTime | date:'HH:mm' }} - {{ state.data.tomorrow.endTime | date:'HH:mm' }}</strong></p>
              <p><strong>Spot-hinta: </strong> <strong class="{{ getPriceCssClass(state.data.tomorrow.priceCategory) }}">{{ getPriceEmoji(state.data.tomorrow.priceCategory) }} {{ state.data.tomorrow.priceAvg | number:'1.2-2' }} c/kWh</strong> ({{ getPriceCategoryText(state.data.tomorrow.priceCategory) }})</p>
              <p><strong>Pesun hinta: </strong> <strong class="{{ getPriceCssClass(state.data.tomorrow.priceCategory) }}">{{ centsToEuros(state.data.tomorrow.estimatedTotalPriceCents) | number:'1.2-2' }} ‚Ç¨</strong></p>
              <p class="savings-comparison" *ngIf="state.data.tomorrow.potentialSavingsCents > 0">
                <strong>üí∞ S√§√§st√∂ vs. nyt: </strong> <strong class="price-cheap">{{ centsToEuros(state.data.tomorrow.potentialSavingsCents) | number:'1.2-2' }} ‚Ç¨</strong> (<strong>{{ state.data.tomorrow.potentialSavingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info">
                <strong>üí°</strong> Vaihtoehtoinen {{ getPriceCategoryText(state.data.tomorrow.priceCategory) }} aika
              </p>
            </div>
          </div>
        </div>

        <!-- No recommendations message -->
        <div *ngIf="!state.data.today && !state.data.tonight && !state.data.tomorrow" appCardContentHighlighted>
          <p><strong>Optimaalisia aikoja ei ole saatavilla</strong></p>
          <p>Kaikissa saatavilla olevissa aikav√§leiss√§ on samankaltainen hinnoittelu. Voit ajaa pesukoneen milloin vain sopii.</p>
        </div>
      </div>

      <!-- Initial State - Show Get Schedule Button -->
      <div *ngIf="!state.loading && !state.data && !state.error" class="initial-state">
        <p>Napsauta alla olevaa painiketta saadaksesi AI-avusteiset suositukset optimaaliselle pyykinpesuajalle perustuen:</p>
        <ul>
          <li>Suomen nykyiset s√§hk√∂n spot-hinnat</li>
          <li>2 tunnin pesujakson kesto</li>
          <li>1,5 kWh energiankulutus</li>
          <li>Kustannusoptimointianalyysi ja s√§√§st√∂laskurit</li>
        </ul>

        <button
          type="button"
          class="get-schedule-button"
          data-test-id="get-schedule-button"
          (click)="getOptimalSchedule()">
          Hae parhaat pesuajat
        </button>
      </div>


      <!-- Tips Section -->
      <div class="tips-section">
        <div class="tips-content">

          <div class="tip-category">
            <h4>üîç MIKSI PIDEMPI OHJELMA EI KULUTA ENEMM√ÑN:</h4>
            <ul class="tip-list">
              <li><strong>L√§mmitys sy√∂ s√§hk√∂√§</strong> - ei aika! Suurin kulutus tulee veden l√§mmitt√§misest√§</li>
              <li><strong>ECO-ohjelmat (2-3h)</strong> k√§ytt√§v√§t matalampaa l√§mp√∂tilaa = s√§√§st√§v√§t energiaa</li>
              <li><strong>Pumput ja rumpu</strong> kuluttavat v√§h√§n (&lt;10% kokonaiskulutuksesta)</li>
              <li><strong>Pidempi pesu</strong> = parempi pesutulos matalammassa l√§mp√∂tilassa</li>
            </ul>
          </div>

          <div class="tip-category">
            <h4>üí° ENERGIANS√Ñ√ÑST√ñVINKIT:</h4>
            <ul class="tip-list savings-tips">
              <li>‚úÖ <strong>Valitse 30-40¬∞C</strong> riitt√§√§ useimmiten (s√§√§st√§√§ 50% energiasta)</li>
              <li>‚úÖ <strong>K√§yt√§ ECO-ohjelmia</strong> huolimatta pituudesta</li>
              <li>‚úÖ <strong>T√§yt√§ kone t√§yteen</strong> mutta √§l√§ ahtaa</li>
              <li>‚úÖ <strong>Ohita esipesu</strong> jos mahdollista</li>
              <li>‚úÖ <strong>Uudet nestepesuaineet</strong> toimivat kylm√§ss√§kin</li>
            </ul>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>