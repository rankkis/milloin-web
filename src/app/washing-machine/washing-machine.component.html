<div appCard>
  <div appCardHeader
       title="on paras hetki pest√§ pyykki√§?"
       subtitle="Saa AI-avusteiset suositukset s√§hk√∂n hinnan ja aikataulun perusteella"
       [showBackButton]="true"
       backButtonTestId="washing-machine-back-button">
  </div>
  <div appCardContent>
    <div class="washing-machine-content" *ngIf="forecast$ | async as state">

      <!-- Loading State -->
      <div *ngIf="state.loading" class="loading-container">
        <p>Ladataan optimaalisia pesunkaikoja...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="state.error && !state.loading" appCardContentHighlighted class="error-container">
        <p><strong>Virhe:</strong> {{ state.error }}</p>

        <div class="error-actions">
          <button
            type="button"
            class="retry-button"
            data-test-id="retry-forecast-button"
            (click)="getForecast()">
            Yrit√§ uudelleen
          </button>

          <button
            type="button"
            class="debug-button"
            data-test-id="toggle-debug-button"
            (click)="toggleDebugInfo()">
            {{ showDebugInfo ? 'Piilota' : 'N√§yt√§' }} tekninen tieto
          </button>
        </div>

        <!-- Debug Information for iPhone troubleshooting -->
        <div *ngIf="showDebugInfo && state.technicalDetails" class="debug-info">
          <h6>Tekninen tieto (iPhone-vianetsint√§√§ varten):</h6>
          <div class="debug-details">
            <p><strong>Status:</strong> {{ state.technicalDetails.status || 'N/A' }}</p>
            <p><strong>Status Text:</strong> {{ state.technicalDetails.statusText || 'N/A' }}</p>
            <p><strong>URL:</strong> {{ state.technicalDetails.url || 'N/A' }}</p>
            <p><strong>User Agent:</strong> {{ state.technicalDetails.userAgent || 'N/A' }}</p>
            <p><strong>Online:</strong> {{ state.technicalDetails.online ? 'Kyll√§' : 'Ei' }}</p>
            <p><strong>Aikaleima:</strong> {{ state.technicalDetails.timestamp || 'N/A' }}</p>
            <p><strong>Viesti:</strong> {{ state.technicalDetails.message || 'N/A' }}</p>
          </div>

          <button
            type="button"
            class="copy-button"
            data-test-id="copy-debug-button"
            (click)="copyDebugInfo(state.technicalDetails)">
            Kopioi tekninen tieto
          </button>
        </div>
      </div>

      <!-- Success State with Forecast Data -->
      <div *ngIf="state.data && !state.loading && !state.error" class="forecast-container">

        <!-- Primary Recommendation: Today's Best Time (Highlighted) -->
        <div *ngIf="state.data.today" class="primary-recommendation" appCardContentHighlighted>
          <h3>üü¢ Paras aika pest√§ pyykki√§ on t√§n√§√§n</h3>
          <div class="primary-time">
            <p class="time-display">{{ state.data.today.startTime | date:'HH:mm' }} - {{ state.data.today.endTime | date:'HH:mm' }}</p>
            <p class="price-info">Hinta: {{ state.data.today.price | number:'1.2-2' }} c/kWh (+siirto)</p>
          </div>
        </div>

        <!-- Alternative Options: Tonight/Tomorrow (Regular styling) -->
        <div *ngIf="state.data.tonight || state.data.tomorrow" class="alternatives-section">
          <h4>Vaihtoehtoiset ajat</h4>

          <!-- Tonight's Alternative -->
          <div *ngIf="state.data.tonight" class="time-slot alternative">
            <h5>... jos y√∂ll√§ on OK ajaa pyykki√§, niin se voisi kannattaa</h5>
            <div class="alternative-details">
              <p><strong>Aika:</strong> {{ state.data.tonight.startTime | date:'HH:mm' }} - {{ state.data.tonight.endTime | date:'HH:mm' }}</p>
              <p><strong>Hinta:</strong> {{ state.data.tonight.price | number:'1.2-2' }} c/kWh</p>
              <p class="savings-comparison">
                <strong>S√§√§st√∂:</strong> {{ state.data.tonight.savingsPercentage | number:'1.1-1' }}%
                <span *ngIf="state.data.today">({{ (state.data.today.price - state.data.tonight.price) | number:'1.2-2' }} c/kWh halvempaa kuin t√§n√§√§n)</span>
              </p>
            </div>
          </div>

          <!-- Tomorrow's Alternative -->
          <div *ngIf="state.data.tomorrow" class="time-slot alternative">
            <h5>... jos huomiseen voit s√§√§st√§√§, niin se voisi kannattaa</h5>
            <div class="alternative-details">
              <p><strong>Aika:</strong> {{ state.data.tomorrow.startTime | date:'HH:mm' }} - {{ state.data.tomorrow.endTime | date:'HH:mm' }}</p>
              <p><strong>Hinta:</strong> {{ state.data.tomorrow.price | number:'1.2-2' }} c/kWh</p>
              <p class="savings-comparison">
                <strong>S√§√§st√∂:</strong> {{ state.data.tomorrow.savingsPercentage | number:'1.1-1' }}%
                <span *ngIf="state.data.today">({{ (state.data.today.price - state.data.tomorrow.price) | number:'1.2-2' }} c/kWh halvempaa kuin t√§n√§√§n)</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Fallback: No Today Available - Highlight Best Available -->
        <div *ngIf="!state.data.today && (state.data.tonight || state.data.tomorrow)" class="primary-recommendation" appCardContentHighlighted>
          <h3>üü¢ Paras saatavilla oleva aika</h3>

          <!-- Show tonight if available, otherwise tomorrow -->
          <div *ngIf="state.data.tonight; else tomorrowFallback" class="primary-time">
            <p class="period-label">T√§n√§ y√∂n√§</p>
            <p class="time-display">{{ state.data.tonight.startTime | date:'HH:mm' }} - {{ state.data.tonight.endTime | date:'HH:mm' }}</p>
            <p class="price-info">Hinta: {{ state.data.tonight.price | number:'1.2-2' }} c/kWh</p>
          </div>

          <ng-template #tomorrowFallback>
            <div *ngIf="state.data.tomorrow" class="primary-time">
              <p class="period-label">Huomenna</p>
              <p class="time-display">{{ state.data.tomorrow.startTime | date:'HH:mm' }} - {{ state.data.tomorrow.endTime | date:'HH:mm' }}</p>
              <p class="price-info">Hinta: {{ state.data.tomorrow.price | number:'1.2-2' }} c/kWh</p>
            </div>
          </ng-template>
        </div>

        <!-- No recommendations message -->
        <div *ngIf="!state.data.today && !state.data.tonight && !state.data.tomorrow" appCardContentHighlighted>
          <p><strong>Optimaalisia aikoja ei ole saatavilla</strong></p>
          <p>Kaikissa saatavilla olevissa aikav√§leiss√§ on samankaltainen hinnoittelu. Voit ajaa pesukoneen milloin vain sopii.</p>
        </div>
      </div>

      <!-- Initial State - Show Get Forecast Button -->
      <div *ngIf="!state.loading && !state.data && !state.error" class="initial-state">
        <p>Napsauta alla olevaa painiketta saadaksesi AI-avusteiset suositukset optimaaliselle pyykinpesuajalle perustuen:</p>
        <ul>
          <li>Suomen nykyiset s√§hk√∂n spot-hinnat</li>
          <li>2 tunnin pesujakson kesto</li>
          <li>Kustannusoptimointianalyysi</li>
        </ul>

        <button
          type="button"
          class="get-forecast-button"
          data-test-id="get-forecast-button"
          (click)="getForecast()">
          Hae parhaat pesuajat
        </button>
      </div>

      <!-- Refresh button when data is loaded -->
      <div *ngIf="state.data && !state.loading" class="refresh-container">
        <button
          type="button"
          class="refresh-button"
          data-test-id="refresh-forecast-button"
          (click)="getForecast()">
          P√§ivit√§ ennuste
        </button>
      </div>

    </div>
  </div>
</div>