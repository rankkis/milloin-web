<div appCard>
  <div appCardHeader
       title="on paras hetki pest√§ pyykki√§?"
       subtitle="Saa AI-avusteiset suositukset s√§hk√∂n hinnan ja aikataulun perusteella"
       [showBackButton]="true"
       backButtonTestId="washing-machine-back-button"
       [showRefreshButton]="true"
       refreshButtonTestId="refresh-forecast-button"
       (refreshClicked)="getForecast()">
  </div>
  <div appCardContent>
    <div class="washing-machine-content" *ngIf="forecast$ | async as state">

      <!-- Loading State -->
      <div *ngIf="state.loading" class="loading-container">
        <p>Ladataan optimaalisia pesuaikoja...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="state.error && !state.loading" appCardContentHighlighted class="error-container">
        <p><strong>Virhe:</strong> {{ state.error }}</p>

        <div class="error-actions">
          <button
            type="button"
            class="retry-button"
            data-test-id="retry-forecast-button"
            (click)="getForecast()">
            Yrit√§ uudelleen
          </button>
        </div>
      </div>

      <!-- Success State with Forecast Data -->
      <div *ngIf="state.data && !state.loading && !state.error" class="forecast-container">

        <!-- Primary Recommendation: Today's Best Time (Highlighted) -->
        <div *ngIf="state.data.today" class="primary-recommendation" appCardContentHighlighted>

          <!-- Special message when currently in optimal time -->
          <div *ngIf="isCurrentlyOptimalTime(state.data.today)">
            <h3>üéâ NYT on t√§ydellinen aika pest√§ pyykki√§! üß∫‚ú®</h3>
            <div class="current-optimal-time">
              <p class="now-message">‚è∞ Olet nyt optimaalisessa aikaikkunassa!</p>
              <p class="price-info">Spot-hinta: <strong>{{ state.data.today.price | number:'1.2-2' }} c/kWh</strong></p>
              <p class="cost-info">Pesun hinta: <strong>{{ calculateWashCost(state.data.today) | number:'1.2-2' }} sentti√§</strong></p>
              <p class="action-message">üëç K√§ynnist√§ pesukone nyt saadaksesi parhaan hinnan!</p>
            </div>
          </div>

          <!-- Normal message when optimal time is not now -->
          <div *ngIf="!isCurrentlyOptimalTime(state.data.today)">
            <h3>üü¢ Paras aika pest√§ pyykki√§ on t√§n√§√§n</h3>
            <div class="primary-time">
              <p class="time-display">{{ state.data.today.startTime | date:'HH:mm' }} - {{ state.data.today.endTime | date:'HH:mm' }}</p>
              <p class="price-info">Spot-hinta: <strong>{{ state.data.today.price | number:'1.2-2' }} c/kWh</strong></p>
              <p class="cost-info">Pesun hinta: <strong>{{ calculateWashCost(state.data.today) | number:'1.2-2' }} sentti√§</strong></p>
              <p class="savings-info" *ngIf="calculatePotentialSavings(state.data.today) as savings">
                <strong>Arvioitu s√§√§st√∂ vs. nyt:</strong> <strong>{{ savings.savingsCents | number:'1.2-2' }} sentti√§</strong> (<strong>{{ savings.savingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info" *ngIf="!calculatePotentialSavings(state.data.today)">
                <strong>üí° Optimaalinen aika:</strong> T√§m√§ on paras saatavilla oleva aika edullisen hinnan vuoksi
              </p>
            </div>
          </div>
        </div>

        <!-- Alternative Options: Tonight/Tomorrow (Regular styling) -->
        <div *ngIf="state.data.tonight || state.data.tomorrow" class="alternatives-section">
          <h4>Vaihtoehtoiset ajat</h4>

          <!-- Tonight's Alternative -->
          <div *ngIf="state.data.tonight" class="time-slot alternative">
            <h5>... jos y√∂ll√§ on OK ajaa pyykki√§, niin se voisi kannattaa</h5>
            <div class="alternative-details">
              <p><strong>Aika:</strong> {{ state.data.tonight.startTime | date:'HH:mm' }} - {{ state.data.tonight.endTime | date:'HH:mm' }}</p>
              <p><strong>Spot-hinta:</strong> <strong>{{ state.data.tonight.price | number:'1.2-2' }} c/kWh</strong> (+siirto)</p>
              <p><strong>Pesun hinta:</strong> <strong>{{ calculateWashCost(state.data.tonight) | number:'1.2-2' }} sentti√§</strong></p>
              <p class="savings-comparison" *ngIf="calculatePotentialSavings(state.data.tonight) as savings">
                <strong>Arvioitu s√§√§st√∂ vs. nyt:</strong> <strong>{{ savings.savingsCents | number:'1.2-2' }} sentti√§</strong> (<strong>{{ savings.savingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info" *ngIf="!calculatePotentialSavings(state.data.tonight)">
                <strong>üí°</strong> Vaihtoehtoinen edullinen aika
              </p>
            </div>
          </div>

          <!-- Tomorrow's Alternative -->
          <div *ngIf="state.data.tomorrow" class="time-slot alternative">
            <h5>... jos huomiseen voit s√§√§st√§√§, niin se voisi kannattaa</h5>
            <div class="alternative-details">
              <p><strong>Aika:</strong> {{ state.data.tomorrow.startTime | date:'HH:mm' }} - {{ state.data.tomorrow.endTime | date:'HH:mm' }}</p>
              <p><strong>Spot-hinta:</strong> <strong>{{ state.data.tomorrow.price | number:'1.2-2' }} c/kWh</strong> (+siirto)</p>
              <p><strong>Pesun hinta:</strong> <strong>{{ calculateWashCost(state.data.tomorrow) | number:'1.2-2' }} sentti√§</strong></p>
              <p class="savings-comparison" *ngIf="calculatePotentialSavings(state.data.tomorrow) as savings">
                <strong>Arvioitu s√§√§st√∂ vs. nyt:</strong> <strong>{{ savings.savingsCents | number:'1.2-2' }} sentti√§</strong> (<strong>{{ savings.savingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info" *ngIf="!calculatePotentialSavings(state.data.tomorrow)">
                <strong>üí°</strong> Vaihtoehtoinen edullinen aika
              </p>
            </div>
          </div>
        </div>

        <!-- Fallback: No Today Available - Highlight Best Available -->
        <div *ngIf="!state.data.today && (state.data.tonight || state.data.tomorrow)" class="primary-recommendation" appCardContentHighlighted>
          <h3>üü¢ Paras saatavilla oleva aika</h3>

          <!-- Show tonight if available, otherwise tomorrow -->
          <div *ngIf="state.data.tonight; else tomorrowFallback" class="primary-time">
            <p class="period-label">T√§n√§ y√∂n√§</p>
            <p class="time-display">{{ state.data.tonight.startTime | date:'HH:mm' }} - {{ state.data.tonight.endTime | date:'HH:mm' }}</p>
            <p class="price-info">Spot-hinta: <strong>{{ state.data.tonight.price | number:'1.2-2' }} c/kWh</strong></p>
            <p class="cost-info">Pesun hinta: <strong>{{ calculateWashCost(state.data.tonight) | number:'1.2-2' }} sentti√§</strong></p>
            <p class="savings-info" *ngIf="calculatePotentialSavings(state.data.tonight) as savings">
              <strong>Arvioitu s√§√§st√∂ vs. nyt:</strong> <strong>{{ savings.savingsCents | number:'1.2-2' }} sentti√§</strong> (<strong>{{ savings.savingsPercentage | number:'1.1-1' }}%</strong>)
            </p>
            <p class="optimal-info" *ngIf="!calculatePotentialSavings(state.data.tonight)">
              <strong>üí° Optimaalinen aika:</strong> Paras saatavilla oleva edullinen aika
            </p>
          </div>

          <ng-template #tomorrowFallback>
            <div *ngIf="state.data.tomorrow" class="primary-time">
              <p class="period-label">Huomenna</p>
              <p class="time-display">{{ state.data.tomorrow.startTime | date:'HH:mm' }} - {{ state.data.tomorrow.endTime | date:'HH:mm' }}</p>
              <p class="price-info">Energian hinta: <strong>{{ state.data.tomorrow.price | number:'1.2-2' }} c/kWh</strong></p>
              <p class="cost-info">Pesun hinta: <strong>{{ calculateWashCost(state.data.tomorrow) | number:'1.2-2' }} sentti√§</strong></p>
              <p class="savings-info" *ngIf="calculatePotentialSavings(state.data.tomorrow) as savings">
                <strong>Arvioitu s√§√§st√∂ vs. nyt:</strong> <strong>{{ savings.savingsCents | number:'1.2-2' }} sentti√§</strong> (<strong>{{ savings.savingsPercentage | number:'1.1-1' }}%</strong>)
              </p>
              <p class="optimal-info" *ngIf="!calculatePotentialSavings(state.data.tomorrow)">
                <strong>üí° Optimaalinen aika:</strong> Paras saatavilla oleva edullinen aika
              </p>
            </div>
          </ng-template>
        </div>

        <!-- No recommendations message -->
        <div *ngIf="!state.data.today && !state.data.tonight && !state.data.tomorrow" appCardContentHighlighted>
          <p><strong>Optimaalisia aikoja ei ole saatavilla</strong></p>
          <p>Kaikissa saatavilla olevissa aikav√§leiss√§ on samankaltainen hinnoittelu. Voit ajaa pesukoneen milloin vain sopii.</p>
        </div>
      </div>

      <!-- Initial State - Show Get Forecast Button -->
      <div *ngIf="!state.loading && !state.data && !state.error" class="initial-state">
        <p>Napsauta alla olevaa painiketta saadaksesi AI-avusteiset suositukset optimaaliselle pyykinpesuajalle perustuen:</p>
        <ul>
          <li>Suomen nykyiset s√§hk√∂n spot-hinnat</li>
          <li>2 tunnin pesujakson kesto</li>
          <li>1,5 kWh energiankulutus</li>
          <li>Kustannusoptimointianalyysi ja s√§√§st√∂laskurit</li>
        </ul>

        <button
          type="button"
          class="get-forecast-button"
          data-test-id="get-forecast-button"
          (click)="getForecast()">
          Hae parhaat pesuajat
        </button>
      </div>


      <!-- Tips Section -->
      <div class="tips-section">
        <div class="tips-content">

          <div class="tip-category">
            <h4>üîç MIKSI PIDEMPI OHJELMA EI KULUTA ENEMM√ÑN:</h4>
            <ul class="tip-list">
              <li><strong>L√§mmitys sy√∂ s√§hk√∂√§</strong> - ei aika! Suurin kulutus tulee veden l√§mmitt√§misest√§</li>
              <li><strong>ECO-ohjelmat (2-3h)</strong> k√§ytt√§v√§t matalampaa l√§mp√∂tilaa = s√§√§st√§v√§t energiaa</li>
              <li><strong>Pumput ja rumpu</strong> kuluttavat v√§h√§n (&lt;10% kokonaiskulutuksesta)</li>
              <li><strong>Pidempi pesu</strong> = parempi pesutulos matalammassa l√§mp√∂tilassa</li>
            </ul>
          </div>

          <div class="tip-category">
            <h4>üí° ENERGIANS√Ñ√ÑST√ñVINKIT:</h4>
            <ul class="tip-list savings-tips">
              <li>‚úÖ <strong>Valitse 30-40¬∞C</strong> riitt√§√§ useimmiten (s√§√§st√§√§ 50% energiasta)</li>
              <li>‚úÖ <strong>K√§yt√§ ECO-ohjelmia</strong> huolimatta pituudesta</li>
              <li>‚úÖ <strong>T√§yt√§ kone t√§yteen</strong> mutta √§l√§ ahtaa</li>
              <li>‚úÖ <strong>Ohita esipesu</strong> jos mahdollista</li>
              <li>‚úÖ <strong>Uudet nestepesuaineet</strong> toimivat kylm√§ss√§kin</li>
            </ul>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>